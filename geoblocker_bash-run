#!/bin/bash -l

# geoblocker_bash-run

# runs the geoblocker_bash-fetch script to fetch ip list from RIPE
# then runs geoblocker_bash-apply to apply the ip list to iptables


me=$(basename "$0")

#### FUNCTIONS

usage() {
    cat <<EOF

Runs the geoblocker_bash-fetch script to fetch ip list from RIPE.
Then runs geoblocker_bash-apply to apply the ip list to iptables.

    Usage: $me -c country -p path -k path [-d] [-h]

    Options:
    -c tld     : tld / country code
    -p path    : Path to store the compiled whitelist
    -k path    : Path to file where last known-good iptables state will be saved
    -s         : Skip fetching (only run the apply script)

    -d         : Debug
    -h         : This help

EOF
}

die() {
	echo "$@" 1>&2
	echo ""
	logger -t geoblocker_bash-run "$@"
	exit 1
}

#### PARSE ARGUMENTS

while getopts "c:p:k:sdh" opt; do
	case $opt in
	c) country=$OPTARG;;
	p) whitelist_path=$OPTARG;;
	k) knowngood_file=$OPTARG;;
	s) skipfetch="true";;
	d) debug="-d";;
	h) usage; exit 0;;
	\?) usage; exit 1;;
	esac
done
shift $((OPTIND -1))


#### Initialize variables

echo ""

#### Checks

# check for geoblocker_bash-fetch
[ ! $skipfetch ] && if ! command -v geoblocker_bash-fetch &> /dev/null; then
	err="Error: Cannot find \"geoblocker_bash-fetch\". Did you run setup? Exiting."
	die "$err"
fi

# check for geoblocker_bash-apply
if ! command -v geoblocker_bash-apply &> /dev/null; then
	err="Error: Cannot find \"geoblocker_bash-apply\". Did you run setup? Exiting."
	die "$err"
fi


if [ -z "$country" ]; then
	err="Specify country with -c! Exiting."
	usage
	echo ""
	die "$err"
fi

if [ -z "$knowngood_file" ]; then
	err="Error: Known-good file path can not be empty! Exiting."
	usage
	echo ""
	die "$err"
fi

if [ -z "$whitelist_path" ]; then
	err="Error: Whitelist file path can not be empty! Exiting."
	usage
	echo ""
	die "$err"
fi

# check for root
if [ "$EUID" -ne 0 ]; then
	err="This needs to be run as root."
	echo ""
	die "$err"
fi

#### Main

if [ ! $skipfetch ]; then
	geoblocker_bash-fetch $debug -c "$country" -p "$whitelist_path"; rv=$?
	if [ $rv -ne 0 ]; then
		echo ""
		exit 1
	else
		[ $debug ] && echo "Successfully retrieved ip list from RIPE."
		logger -t geoblocker_bash-run "Successfully fetched the whitelist."
	fi
else
	echo "Note: Skipped fetching because -s switch was used"
fi

geoblocker_bash-apply $debug -f "$whitelist_path/ipv4_$country" -b "$knowngood_file"; rv=$?
if [ $rv -ne 0 ]; then
	echo ""
	exit 1
else
	[ $debug ] && echo "Successfully applied the whitelist."
fi

logger -t geoblocker_bash-run "Successfully applied the whitelist."

echo ""

exit 0
